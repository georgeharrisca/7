<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extract Part 1 from MusicXML</title>
  <script>
    function parseXML(file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(event.target.result, "application/xml");
        
        // Step 1: Find the <part-list> element
        const partListElement = xmlDoc.getElementsByTagName('part-list')[0];
        
        // Step 2: Create a new document and copy all content up to and including <part-list>
        let newDoc = document.implementation.createDocument(null, 'score-partwise');
        let root = newDoc.documentElement;

        // Step 3: Copy all elements before and including <part-list>
        let child = xmlDoc.documentElement.firstChild;
        while (child) {
          root.appendChild(child.cloneNode(true));
          if (child === partListElement) {
            break;  // Stop once we have copied <part-list>
          }
          child = child.nextSibling;
        }

        // Step 4: Find <score-part id="P1"> and copy it until the next </score-part>
        const scoreParts = xmlDoc.getElementsByTagName('score-part');
        for (let i = 0; i < scoreParts.length; i++) {
          if (scoreParts[i].getAttribute('id') === 'P1') {
            let scorePartClone = scoreParts[i].cloneNode(true);
            root.appendChild(scorePartClone);
            break;
          }
        }

        // Step 5: Add the closing </part-list> tag
        const partListEndTag = newDoc.createElement('part-list');
        root.appendChild(partListEndTag);

        // Step 6: Find <part id="P1"> and copy it until the next </part>
        const parts = xmlDoc.getElementsByTagName('part');
        for (let i = 0; i < parts.length; i++) {
          if (parts[i].getAttribute('id') === 'P1') {
            let partClone = parts[i].cloneNode(true);
            root.appendChild(partClone);
            break;
          }
        }

        // Step 7: Add the closing </score-partwise> tag
        // (This is automatically handled by the XML structure since it's the root element)

        // Step 8: Serialize the new document into a string
        const serializer = new XMLSerializer();
        const xmlString = serializer.serializeToString(newDoc);
        
        // Create a blob and generate a download link for the new file
        const blob = new Blob([xmlString], { type: 'application/xml' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'part_1_extracted.xml';
        link.click();
      };
      reader.readAsText(file);
    }
  </script>
</head>
<body>
  <h1>Extract Part 1 from MusicXML</h1>
  <input type="file" id="xmlFile" accept=".xml, .mxl" />
  <button onclick="startProcessing()">Extract Part 1</button>

  <script>
    function startProcessing() {
      const fileInput = document.getElementById('xmlFile');
      if (fileInput.files.length === 0) {
        alert('Please select a MusicXML file.');
        return;
      }

      const file = fileInput.files[0];
      parseXML(file);
    }
  </script>
</body>
</html>
